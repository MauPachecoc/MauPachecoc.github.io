<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbería Galoz - Reservas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #1a1a1a;
            color: #f5f5f5;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: #e53935;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        p { color: #ccc; margin-bottom: 30px; }
        .chat-container {
            max-width: 420px;
            margin: 20px auto;
            border: 2px solid #e53935;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
            background: #2c2c2c;
        }
        .chat-messages {
            height: 380px;
            overflow-y: auto;
            padding: 15px;
            background: #222;
            display: flex;
            flex-direction: column;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            background: #1e1e1e;
        }
        input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            background: #333;
            color: white;
            outline: none;
            font-size: 1rem;
        }
        input::placeholder { color: #888; }
        button {
            padding: 12px 20px;
            background: #e53935;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: background 0.3s;
        }
        button:hover { background: #c62828; }
        .user-message {
            background-color: #e53935;
            color: white;
            align-self: flex-end;
            border-radius: 18px 18px 4px 18px;
            padding: 10px 14px;
            margin: 6px 0;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .bot-message {
            background-color: #333;
            color: #f0f0f0;
            align-self: flex-start;
            border-radius: 18px 18px 18px 4px;
            padding: 10px 14px;
            margin: 6px 0;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .horario-btn {
            display: inline-block;
            margin: 4px;
            padding: 8px 12px;
            background: #444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .horario-btn:hover {
            background: #e53935;
        }
    </style>
</head>
<body>
    <h1>✂️ Barbería Galoz</h1>
    <p>Reserva tu cita en minutos</p>
    
    <div class="chat-container">
        <div id="chat-messages" class="chat-messages">
            <div class="bot-message"><strong>Barbería:</strong> ¡Hola! ¿Quieres agendar una cita?</div>
        </div>
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Escribe 'agendar' para empezar...">
            <button onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <script>
        const SERVICES_KEYWORDS = {
            "corte": ["corte", "cabello", "peinado"],
            "afeitado": ["afeitado", "navaja", "barbero"],
            "barba": ["barba", "recortar barba"],
            "tinte": ["tinte", "color"],
            "paquete": ["paquete", "completo"]
        };

        const SERVICES_LIST = [
            "• Corte: $10",
            "• Afeitado: $15",
            "• Barba: $12",
            "• Tinte: $20",
            "• Paquete completo: $25"
        ].join("\n");
        

        let appointmentStep = 0;
        let appointmentData = {};
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycby-0OB_KaETgPZYHchwWM4vgxOJNa8JJGR1x8Z0UZnwRRFFfmXsGJ5DeDtR0hJMde-c/exec";

        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            addMessage('Tú: ' + message, 'user-message');
            input.value = '';

            const lowerMsg = message.toLowerCase();

            if (appointmentStep === 0 && (lowerMsg.includes('agendar') || lowerMsg.includes('reservar'))) {
                appointmentStep = 1;
                addMessage('Barbería: ¿Cuál es tu nombre?', 'bot-message');
                return;
            }

            if (appointmentStep > 0) {
                handleAppointment(message, lowerMsg);
                return;
            }

            addMessage('Barbería: Escribe "agendar" para reservar una cita.', 'bot-message');
        }

        function handleAppointment(rawInput, lowerInput) {
            if (appointmentStep === 1) {
                if (rawInput.length < 2) {
                    addMessage('Barbería: Por favor ingresa un nombre válido.', 'bot-message');
                    return;
                }
                appointmentData.name = rawInput;
                appointmentStep = 2;
                addMessage(`Barbería: Gracias, ${appointmentData.name}.\n\nNuestros servicios:\n${SERVICES_LIST}\n\n¿Qué servicio deseas?`, 'bot-message');
            } 
            else if (appointmentStep === 2) {
                let service = null;
                for (const [key, words] of Object.entries(SERVICES_KEYWORDS)) {
                    if (words.some(w => lowerInput.includes(w))) {
                        service = key.charAt(0).toUpperCase() + key.slice(1);
                        break;
                    }
                }
                if (!service) {
                    addMessage('Barbería: No reconocí el servicio. Elige uno de la lista.', 'bot-message');
                    return;
                }
                appointmentData.service = service;
                appointmentStep = 3;
                addMessage('Barbería: ¿Qué fecha deseas?', 'bot-message');
            }
            else if (appointmentStep === 3) {
                const date = parseNaturalDateToDDMMYYYY(rawInput);
                if (!date) {
                    addMessage('Barbería: Usa el formato: "8 de noviembre".', 'bot-message');
                    return;
                }
                appointmentData.date = date;
                loadAvailableTimes(date);
            }
        }

        function loadAvailableTimes(fecha) {
            addMessage('Barbería: Consultando horarios disponibles...', 'bot-message');
            fetch(`${GOOGLE_SHEET_URL}?action=getHorarios&fecha=${encodeURIComponent(fecha)}`)
                .then(res => res.json())
                .then(horarios => {
                    if (horarios.length === 0) {
                        addMessage('Barbería: ❌ No hay horarios disponibles ese día.', 'bot-message');
                        resetFlow();
                    } else {
                        appointmentStep = 4;
                        showTimeOptions(horarios);
                    }
                })
                .catch(err => {
                    console.error(err);
                    addMessage('Barbería: ⚠️ Error al cargar horarios. Inténtalo más tarde.', 'bot-message');
                    resetFlow();
                });
        }

        function showTimeOptions(horarios) {
            let msg = 'Barbería: Elige un horario disponible:<br>';
            horarios.forEach(h => {
                msg += `<span class="horario-btn" onclick="selectTime('${h}')">${h}</span> `;
            });
            const div = document.createElement('div');
            div.className = 'bot-message';
            div.innerHTML = msg;
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }

        function selectTime(time) {
            // Desactivar botones
            document.querySelectorAll('.horario-btn').forEach(b => b.style.pointerEvents = 'none');
            appointmentData.time = time;
            finalizeAppointment();
        }

        function parseNaturalDateToDDMMYYYY(input) {
            const months = {
                "enero": "01", "febrero": "02", "marzo": "03", "abril": "04",
                "mayo": "05", "junio": "06", "julio": "07", "agosto": "08",
                "septiembre": "09", "octubre": "10", "noviembre": "11", "diciembre": "12"
            };
            const lower = input.toLowerCase();
            const dayMatch = lower.match(/\b(\d{1,2})\b/);
            if (!dayMatch) return null;
            const day = parseInt(dayMatch[1], 10);
            if (day < 1 || day > 31) return null;
            for (const [name, num] of Object.entries(months)) {
                if (lower.includes(name)) {
                    return `${day.toString().padStart(2, '0')}/${num}/2025`;
                }
            }
            return null;
        }

        function finalizeAppointment() {
            addMessage(`Barbería: ✅ ¡Cita agendada!\nNombre: ${appointmentData.name}\nServicio: ${appointmentData.service}\nFecha: ${appointmentData.date}\nHora: ${appointmentData.time}`, 'bot-message');
            sendToGoogleSheets(appointmentData);
            resetFlow();
        }

        function sendToGoogleSheets(data) {
            fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(console.error);
        }

        function resetFlow() {
            appointmentStep = 0;
            appointmentData = {};
        }

        function addMessage(text, className) {
            const messages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>